<!DOCTYPE html>
<html lang="en">

<head>

  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="">
  <meta name="author" content="">

  <title>GlideSkyHy</title>

  <!-- Bootstrap core CSS -->
  <link href="vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">
  <link href="css/sk_common.css" rel="stylesheet">

  <!-- Custom fonts for this template -->
  <link href="https://fonts.googleapis.com/css?family=Catamaran:100,200,300,400,500,600,700,800,900" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css?family=Lato:100,100i,300,300i,400,400i,700,700i,900,900i" rel="stylesheet">
  <link href="vendor/colorpicker/css/bootstrap-colorpicker.css" rel="stylesheet">

  <script src="https://code.jquery.com/jquery-3.5.0.js"></script>

  <!-- Custom styles for this template -->
  <script src="https://polyfill.io/v3/polyfill.min.js?features=default"></script>
  <!-- Bootstrap core JavaScript -->
  <!-- <script src="vendor/jquery/jquery.slim.min.js"></script> -->
  <script src="vendor/easeljs.min.js"></script>
  <script src="vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
  <script src="vendor/colorpicker/js/bootstrap-colorpicker.min.js"></script>
  <script src="js/sk_common.js"></script>
  <!--<script  type="text/javascript"  src="../routes/index.js"></script>-->


  <style type="text/css">
    /* Always set the map height explicitly to define the size of the div
     * element that contains the map. */
    #map {
      height: 100%;
    }

    /* Optional: Makes the sample page fill the window. */
    html,
    body {
      height: 100%;
      margin: 0;
      padding: 0;
    }
  </style>
  <script>

    let map;
    var curr_lat = 0;
    var curr_lng = 0;
    // get current location
    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(
        (position) => {
          // console.log("position.coords.latitude:"+position.coords.latitude);
          curr_lat = position.coords.latitude;
          curr_lng = position.coords.longitude;
          // console.log("current:"+curr_lat+"//"+curr_lng);
        }
      );
    }

    function initMap() {
      var overlayObjList = [];
      map = new google.maps.Map(document.getElementById("map"), {
        center: { lat: curr_lat, lng: curr_lng },
        zoom: 14.4,
        mapTypeId: "satellite",
      });

      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
          (position) => {
            const pos = {
                //lat: position.coords.latitude,
              //lng: position.coords.longitude,
              lat: 32.428646,
              lng: -111.389273,
            };
            map.setCenter(pos);
          },
          () => {
            handleLocationError(true, infoWindow, map.getCenter());
          }
        );
      } else {
        // Browser doesn't support Geolocation
        handleLocationError(false, infoWindow, map.getCenter());
      }

      /**
       * The custom GliderOverlay object contains the Glider image+name+altitude+path,
       * the bounds of the image, and a reference to the map.
       */
      class GliderOverlay extends google.maps.OverlayView {
        constructor(curr_location, image, name, alt, vert_speed, color, path) {
          super();
          this.lat = curr_location[0];
          this.lng = curr_location[1];
          this.image = image;
          this.name = name;
          this.alt = alt;
          this.vert_speed = vert_speed;
          this.color = color;
          this.path = path;
          this.min_lat = this.lat;
          this.max_lat = this.lat;
          this.min_lng = this.lng;
          this.max_lng = this.lng;

          for(var ii=0;ii<path.length;ii++) {
            if(this.min_lat > path[ii].lat) this.min_lat = path[ii].lat;
            if(this.max_lat < path[ii].lat) this.max_lat = path[ii].lat;
            if(this.min_lng > path[ii].lng) this.min_lng = path[ii].lng;
            if(this.max_lng < path[ii].lng) this.max_lng = path[ii].lng;
          }
        }
        /**
         * canvas objects includes current_glider and glider's path together
         *   current_glider : image + location label
         *   glider's path(max 10) : circle
         * next, locate objects and make segments at draw method
         */
        onAdd() {
          // 0. div
          this.div = document.createElement("div");
          this.div.style.borderStyle = "none";
          this.div.style.borderWidth = "0px";
          // this.div.style.borderColor = "black";
          this.div.style.position = "absolute";

          // 1. canvas
          this.canvas = document.createElement("canvas");
          this.div.appendChild(this.canvas);

          // Add the element to the "overlayLayer" pane.
          const panes = this.getPanes();
          panes.overlayLayer.appendChild(this.div);
        }
        draw() {
          const label_width = 80, label_height = 45, history_width = 14;
          const overlayProjection = this.getProjection();
          // 0. fix the size&location of div&canvas
          const nw_point = overlayProjection.fromLatLngToDivPixel(
            new google.maps.LatLng(this.max_lat, this.min_lng)
          );
          const se_point = overlayProjection.fromLatLngToDivPixel(
            new google.maps.LatLng(this.min_lat, this.max_lng)
          );
          // console.log("nw_point:"+this.max_lat+"//"+this.min_lng+"//"+nw_point.x+"//"+(nw_point.y));
          // console.log("se_point:"+this.min_lat+"//"+this.max_lng+"//"+se_point.x+"//"+(se_point.y));
          // Resize div to fit the indicated dimensions.
          if (this.div) {
            this.div.style.left = (nw_point.x-history_width) + "px";
            this.div.style.top = (nw_point.y-history_width) + "px";
            this.div.style.width  = calGap(se_point.x, nw_point.x)+label_width+history_width*2 + "px";
            this.div.style.height = calGap(nw_point.y, se_point.y)+history_width*2 + "px";
            this.canvas.style.left = (nw_point.x-history_width) + "px";
            this.canvas.style.top = (nw_point.y-history_width) + "px";
            this.canvas.width  = calGap(se_point.x, nw_point.x)+label_width+history_width*2; // to stretch label_width
            this.canvas.height = calGap(nw_point.y, se_point.y)+history_width*2;
            // console.log("div size:"+this.div.style.left+"//"+this.div.style.top+"//"+this.div.style.width+"//"+this.div.style.height);
          }
          // console.log("lat/lng:"+this.max_lat+"//"+this.min_lat+"//"+this.max_lng+"//"+this.min_lng+"//"+this.lat+"//"+this.lng);
          // 1. add current_glider
          const point = overlayProjection.fromLatLngToDivPixel(
            new google.maps.LatLng(this.lat, this.lng)
          );
          const point_x = calGap(point.x, nw_point.x+history_width);
          const point_y = calGap(point.y, nw_point.y+history_width);
          // console.log("point:"+this.lat+"//"+this.lng+"//"+point.x+"//"+(point.y));

          var stage = new createjs.Stage(this.canvas);
          // 1.1 location label : div element for name&alt and attach it to the div.
          var text_bg = new createjs.Shape();
          text_bg.graphics.beginFill(this.color).drawRect(point_x, point_y, label_width, label_height);
          stage.addChild(text_bg);
          var text = new createjs.Text(this.name+"\n"+this.alt+" ft"+"\n"+this.vert_speed+" knts", "15px Times", "#000000");
          text.x = point_x;
          text.y = point_y;
          stage.addChild(text);

          // 1.2 image : div element for name&alt and attach it to the div.
          var glider_icon = new createjs.Bitmap(this.image);
          glider_icon.scaleX = 1/3; glider_icon.scaleY = 1/3;
          glider_icon.regX = 44;
          glider_icon.regY = 58;
          glider_icon.x = point_x;
          glider_icon.y = point_y+label_height;
          // add shadow by glider's height
          glider_icon.shadow = new createjs.Shadow("#000000", this.alt/200, this.alt/200, 10);

          // 2. add glider's path and segments
          var seq = 0;
          // start path!
          var path_asis_x, path_asis_y;
          var path1 = new createjs.Shape();
          const color1 = this.color;

          jQuery.each(this.path, function( index, value ) { // for each: index in data update glider position
            seq++;
            const history_point = overlayProjection.fromLatLngToDivPixel(
              new google.maps.LatLng(value.lat, value.lng)
            );

            // add path
            if(seq>1) {
              path1.graphics.setStrokeStyle(10).beginStroke("red")
                   .moveTo(path_asis_x, path_asis_y).lineTo(calGap(history_point.x, nw_point.x)+history_width, calGap(history_point.y, nw_point.y)+history_width);
              path1.alpha = 0.3;
              stage.addChild(path1);
            }
            path_asis_x = calGap(history_point.x, nw_point.x)+history_width;
            path_asis_y = calGap(history_point.y, nw_point.y)+history_width;

            // add circle
            var history_bg = new createjs.Shape();
            history_bg.graphics.beginFill("#FFFFFF").drawCircle(calGap(history_point.x, nw_point.x)+history_width, calGap(history_point.y, nw_point.y)+history_width, history_width);
            stage.addChild(history_bg);

            // add initial
            var history_text = new createjs.Text(value.Name.substring(0,1)+seq, "10px Times", color1);
            history_text.x = calGap(history_point.x, nw_point.x)+history_width/2;
            history_text.y = calGap(history_point.y, nw_point.y)+history_width/2;
            stage.addChild(history_text);
          });
          // path connecting recent history and current location
          //path1.graphics.setStrokeStyle(10).beginStroke("red")
          //     .moveTo(path_asis_x, path_asis_y).lineTo(glider_icon.x, glider_icon.y);
         // path1.alpha = 0.3;
          //stage.addChild(path1);

          // tilt current location's glider_icon
          var deltaX = glider_icon.x - path_asis_x;
          var deltaY = glider_icon.y - path_asis_y;
          var rad = Math.atan2(deltaY, deltaX);
          var deg = rad * (180 / Math.PI);
          glider_icon.rotation = deg;
          stage.addChild(glider_icon);

          stage.update();
        }

        /**
         * The onRemove() method will be called automatically from the API if
         * we ever set the overlay's map property to 'null'.
         */
        onRemove() {
          if (this.div) {
            this.div.parentNode.removeChild(this.div);
            delete this.div;
          }
        }
        /**
         *  Set the visibility to 'hidden' or 'visible'.
         */
        hide() {
          if (this.div) {
            this.div.style.visibility = "hidden";
          }
        }
        show() {
          if (this.div) {
            this.div.style.visibility = "visible";
          }
        }
        toggle() {
          if (this.div) {
            if (this.div.style.visibility === "hidden") {
              this.show();
            } else {
              this.hide();
            }
          }
        }
        toggleDOM(map) {
          if (this.getMap()) {
            this.setMap(null);
          } else {
            this.setMap(map);
          }
        }
      }

      let image = "/img/glider.png";

      redraw();

      function redraw() {
        // setInterval(setTimeout(redraw, 5000)); // 5 sec
        // init overlay list
        // console.log("overlayObjList.length:"+overlayObjList.length);
        overlayObjList.forEach(remove_ovrly);
        function remove_ovrly(value, index, array) {
          value.toggleDOM(map);
          // console.log("remove_ovrly:"+value.name+"//"+value.lat+"//"+value.lng+"//"+index+"//"+array);
        }
        // to hold redrawing objects
        overlayObjList = [];

        //$.get("/getCurrGlider", { lat_s: curr_lat-1, lat_e: curr_lat+1, lng_s: curr_lng-1, lng_e: curr_lng+1 }).done(function(data){ // use loc data @ done func
        $.get("/glider/getCurrGlider", { lat_s: 32, lat_e: 33, lng_s: -112, lng_e: -109 })
        .done(function(data){
          jQuery.each(data, function( index, value ) { // for each: index in data update glider position

            var hist = [];
            $.get("/glider/Database_History_Read", { name: value.name })
            .done(function(data_history){
              // data_history : sort later
              //document.write(data_history);
              let i = 0;
              jQuery.each(data_history, function( index_n, value_n ) {
                // "i == 0" means current glider's position using GliderOverlay
                if(i==0)  {
                   // setInterval(setTimeout(nextPosition, 5000, value_n)); // 5 sec
                } else {
                  // param : lat, lng, image, name, alt, vert_speed, seq
                  // model : Name: String, timestamp: Date, lat: Number, lng: Number, alt: Number, vertical_speed: Number,
                  hist.push(value_n);
                }
                i++;
              });
              const overlay = new GliderOverlay(value.position, image, value.name, value.position[2], value.position[3], value.fly_object[0].color, hist);
              overlay.setMap(map);
              overlayObjList.push(overlay);
            });

            //setInterval(nextPosition, 15000); // 5 sec

          });
        });
      }



      // MouseEvent = click
      map.addListener("click", (e) => {
        placeMarkerAndPanTo(e.latLng, map);
      });


    }


    function placeMarkerAndPanTo(latLng, map) {
      new google.maps.Marker({ // create new marker for clicked location
        position: latLng,
        map: map,
      });
      map.panTo(latLng);

      var userData = $("#currTitle4").html(); // {user_name : glider_user_name} // gives undefined????

      $.get("/glider/Location_Current_Read", { name: userData.user_name })
            .done(function(data_Curr_location){
              jQuery.each(data_Curr_location, function( index_cl, value_cl ) {

                  // Save current location to flight_history
                  // Send the data using post
                  var postingHistory = $.post( "/glider/Flight_History_Write", { Name:value_cl.name, lat:value_cl.position[0], lng:value_cl.position[1], alt:value_cl.position[2], vertical_speed:value_cl.position[3] } );

                  //// Put the results in a div
                  //postingHistory.done(function( data ) {
                  //  //checkLogin(data);
                  //});

                  var newAlt = value_cl.position[2]-300;
                  var postingLocation = $.post( "/glider/Location_Update", { Name:value_cl.name, lat:latLng.lat(), lng:latLng.lng(), alt:newAlt, vertical_speed: newAlt - value_cl.position[2] } );



                  // Add edge
                  const flightPlanCoordinates = [
                    { lat: value_cl.position[0], lng: value_cl.position[1] },
                    { lat: latLng.lat(), lng: latLng.lng() },
                  ];
                  const flightPath = new google.maps.Polyline({
                    path: flightPlanCoordinates,
                    geodesic: true,
                    strokeColor: "red",
                    strokeOpacity: 0.3,
                    strokeWeight: 10,
                  });
                  flightPath.setMap(map);

              });
      });

    }


    //function getlocationRealTime()
    //{
    //  if (navigator.geolocation) {
    //    navigator.geolocation.getCurrentPosition(
    //      (position) => {
    //        // console.log("position.coords.latitude:"+position.coords.latitude);
    //        curr_lat = position.coords.latitude;
    //        curr_lng = position.coords.longitude;
    //        // console.log("current:"+curr_lat+"//"+curr_lng);
    //        var postingRealtime = $.post( "/glider/Realtime_Tracking_Write", { "xyz", curr_lat, curr_lng, 1000, 1000 } );
    //      }
    //    );
    //  }
    //}
//
    //function locationRealTime()
    //{
    //  setInterval(getlocationRealTime(), 10000); // 10sec
    //}

    </script>
</head>

<body>

  <!-- Navigation -->
  <nav class="navbar navbar-expand-lg navbar-dark bg-dark static-top">
    <div class="container-fluid">
      <a class="navbar-brand" href="#">GlideSkyHy</a>
      <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarResponsive" aria-controls="navbarResponsive" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarResponsive">
        <ul class="navbar-nav ml-auto">
          <li class="nav-item active">
            <a class="nav-link" href="#">Pilot View
              <span class="sr-only">(current)</span>
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="#">GroundCrew View</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" onclick='locationRealTime()'>RealTime View</a>
          </li>
          <li class="nav-item">
            <a id="signUpTitle" class="nav-link" href="#" data-toggle="modal" data-target="#modSignUp">Sign up</a>
            <div class="modal fade" id="modSignUp" tabindex="-1" role="dialog" aria-labelledby="signUpTitle">
              <form id="signup" class="user" action="/user/signup" method="POST">
                <div id="dlg_signup" class="modal-dialog" role="document"></div>
              </form>
            </div>
          </li>
          <li class="nav-item">
            <a id="currTitle4" class="nav-link dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false" data-target="#">Log in</a>
            <!-- Dropdown - Login-->
            <div class="dropdown-menu dropdown-menu-right shadow animated--grow-in" aria-labelledby="currTitle4">
                <form id="user" class="user" action="/user/login" method="POST">
                  <div id="dlg_login"></div>
                </form>
                <form id="user1" class="user" action="/user/logout" method="GET">
                  <div id="dlg_logout"></div>
                </form>
            </div>
          </li>
        </ul>
      </div>
    </div>
  </nav>

  <!-- Page Content -->
  <!-- <div class="container">
    <div class="row">
      <div class="col-lg-12 text-center"> -->
        <div id="map"></div>

        <!-- Async script executes immediately and must be after any DOM elements used in callback. -->
        <script
          src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBOSIwGZ0y53C6T_GUnfocU0muCr7bvt1Y&map_ids=95d9a8faa1b776b&callback=initMap&libraries=&v=weekly"
          async
        ></script>
      <!-- </div>
    </div>
  </div> -->

  <script>
  // 1. LOADING
  $.get("/user/getCurrSt").done(function(data){
    checkLogin(data);
  });
  $( "#dlg_signup" ).load( "signup.html" );

  // 2. LOGIN FORM
  $( "#user" ).submit(function( event ) {
    // Stop form from submitting normally
    event.preventDefault();

    // Get some values from elements on the page:
    var $form = $( this ),
      v_u_name = $form.find( "input[id='u_name']" ).val(),
      v_pass_wd = $form.find( "input[id='pass_wd']" ).val(),
      url = $form.attr( "action" );
      // console.log("term:"+v_u_name);

    // Send the data using post
    var posting = $.post( url, { u_name:v_u_name, pass_wd:v_pass_wd } );

    // Put the results in a div
    posting.done(function( data ) {
      checkLogin(data);
    });
  });

  // 3. LOGOUT FORM
  $( "#user1" ).submit(function( event ) {
    // Stop form from submitting normally
    event.preventDefault();
    var $form = $( this ),
    url = $form.attr( "action" );

    // Send the data using post
    $.get(url).done(function(data){
      setCurrTitle4("Log In");
      $("#dlg_logout").html(data);
      $("#dlg_login").html("");
      $("#signUpTitle").show();
    });
  });

    // 4. Signup FORM
    $( "#signup" ).submit(function( event ) {
      console.log("Signup start");
      // Stop form from submitting normally
      event.preventDefault();
      var $form = $( this ),
      v_new_name = $form.find( "input[id='new_name']" ).val(),
      v_new_passwd = $form.find( "input[id='new_passwd']" ).val(),
      v_new_color = $form.find( "input[id='new_color']" ).val(),
      url = $form.attr( "action" );
      // console.log("term:"+v_u_name);

      // Send the data using post
      $.post(url, { new_name:v_new_name, new_passwd:v_new_passwd, new_color:v_new_color } )
       .done(function(data){
         var obj = jQuery.parseJSON(data);
         // console.log(obj.msg);
        if(obj.msg == "") {
          $("#signupMsg").html("Signed up successfully.");
          $("#signupBtn").hide();
        } else {
          $("#signupMsg").html(obj.msg);
        }
      });
    });
  </script>
</body>

</html>
