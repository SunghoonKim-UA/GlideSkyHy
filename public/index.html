<!DOCTYPE html>
<html lang="en">

<head>

  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="">
  <meta name="author" content="">

  <title>GlideSkyHy</title>

  <!-- Bootstrap core CSS -->
  <link href="vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">
  <link href="css/sk_common.css" rel="stylesheet">

  <!-- Custom fonts for this template -->
  <link href="https://fonts.googleapis.com/css?family=Catamaran:100,200,300,400,500,600,700,800,900" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css?family=Lato:100,100i,300,300i,400,400i,700,700i,900,900i" rel="stylesheet">

  <script src="https://code.jquery.com/jquery-3.5.0.js"></script>

  <!-- Custom styles for this template -->
  <script src="https://polyfill.io/v3/polyfill.min.js?features=default"></script>
  <!-- Bootstrap core JavaScript -->
  <!-- <script src="vendor/jquery/jquery.slim.min.js"></script> -->
  <script src="vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
  <script src="js/sk_common.js"></script>
  <!--<script  type="text/javascript"  src="../routes/index.js"></script>-->


  <style type="text/css">
    /* Always set the map height explicitly to define the size of the div
     * element that contains the map. */
    #map {
      height: 100%;
    }

    /* Optional: Makes the sample page fill the window. */
    html,
    body {
      height: 100%;
      margin: 0;
      padding: 0;
    }
  </style>
  <script>

    let map;
    var curr_lat = 0;
    var curr_lng = 0;
    // get current location
    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(
        (position) => {
          // console.log("position.coords.latitude:"+position.coords.latitude);
          curr_lat = position.coords.latitude;
          curr_lng = position.coords.longitude;
          // console.log("current:"+curr_lat+"//"+curr_lng);
        }
      );
    }

    function initMap() {
      var overlayObjList = [];
      map = new google.maps.Map(document.getElementById("map"), {
        center: { lat: curr_lat, lng: curr_lng },
        zoom: 14.4,
        mapTypeId: "satellite",
      });

      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
          (position) => {
            const pos = {
                //lat: position.coords.latitude,
              //lng: position.coords.longitude,
              lat: 32.428646,
              lng: -111.389273,
            };
            map.setCenter(pos);
          },
          () => {
            handleLocationError(true, infoWindow, map.getCenter());
          }
        );
      } else {
        // Browser doesn't support Geolocation
        handleLocationError(false, infoWindow, map.getCenter());
      }

      /**
       * The custom GliderOverlay object contains the Glider image+name+altitude,
       * the bounds of the image, and a reference to the map.
       */
      class GliderOverlay extends google.maps.OverlayView {
        constructor(lat, lng, image, name, alt, vert_speed) {
          super();
          this.lat = lat;
          this.lng = lng;
          this.image = image;
          this.name = name;
          this.alt = alt;
          this.vert_speed = vert_speed;
        }
        /**
         * onAdd is called when the map's panes are ready and the overlay has been
         * added to the map.
         */
        onAdd() {
          this.div = document.createElement("div");
          this.div.style.borderStyle = "none";
          this.div.style.borderWidth = "0px";
          //this.div.style.borderColor = "black";
          this.div.style.position = "absolute";
          // Create the div element for name&alt and attach it to the div.
          const label = document.createElement("div");
          label.innerHTML = this.name+"<BR>"+this.alt+" ft"+"<BR>"+this.vert_speed+" knts";
          label.style.width = "80%";
          label.classList.add("bg-light");
          label.classList.add("h6");
          this.div.appendChild(label);
          // Create the img element and attach it to the div.
          const img = document.createElement("img");
          img.src = this.image;
          img.style.width = "75%";
          img.style.height = "75%";
          // img.style.position = "absolute";
          this.div.appendChild(img);
          // Add the element to the "overlayLayer" pane.
          const panes = this.getPanes();
          panes.overlayLayer.appendChild(this.div);
        }
        draw() {
          const overlayProjection = this.getProjection();
          const point = overlayProjection.fromLatLngToDivPixel(
            new google.maps.LatLng(this.lat, this.lng)
          );
          // console.log("point:"+point.x+"//"+point.y);

          // Resize the image's div to fit the indicated dimensions.
          if (this.div) {
            this.div.style.left = (point.x-50) + "px";
            this.div.style.top = (point.y-50) + "px";
            this.div.style.width = "100px";
            this.div.style.height = "100px";
          }
        }
        /**
         * The onRemove() method will be called automatically from the API if
         * we ever set the overlay's map property to 'null'.
         */
        onRemove() {
          if (this.div) {
            this.div.parentNode.removeChild(this.div);
            delete this.div;
          }
        }
        /**
         *  Set the visibility to 'hidden' or 'visible'.
         */
        hide() {
          if (this.div) {
            this.div.style.visibility = "hidden";
          }
        }
        show() {
          if (this.div) {
            this.div.style.visibility = "visible";
          }
        }
        toggle() {
          if (this.div) {
            if (this.div.style.visibility === "hidden") {
              this.show();
            } else {
              this.hide();
            }
          }
        }
        toggleDOM(map) {
          if (this.getMap()) {
            this.setMap(null);
          } else {
            this.setMap(map);
          }
        }
      }

      // my path overlay
      class GliderPathOverlay extends GliderOverlay {
        constructor(lat, lng, image, name, alt, vert_speed, seq) {
          super();
          // 22, 21, 20, 19, 18, 16, 14, 12, 10
          var dot_arr = [22, 22, 21, 20, 19, 18, 16, 14, 12, 10];

          this.lat = lat;
          this.lng = lng;
          this.image = image;
          this.name = name;
          this.alt = alt;
          this.vert_speed = vert_speed;
          this.seq = seq;
          this.dot_size = dot_arr[seq];
        }
        onAdd() {
          this.div = document.createElement("div");
          this.div.innerHTML=this.name.substring(0,1)+this.seq;
          this.div.style.borderStyle = "none";
          this.div.style.borderWidth = "0px";
          this.div.classList.add("dot_"+this.seq);
          this.div.style.position = "absolute";
          // Add the element to the "overlayLayer" pane.
          const panes = this.getPanes();
          panes.overlayLayer.appendChild(this.div);
        }
        draw() {
          const overlayProjection = this.getProjection();
          const point = overlayProjection.fromLatLngToDivPixel(
            new google.maps.LatLng(this.lat, this.lng)
          );

          // Resize the image's div to fit the indicated dimensions.
          if (this.div) {
            this.div.style.left = (point.x-this.dot_size/2) + "px";
            this.div.style.top = (point.y-this.dot_size/2) + "px";
            this.div.style.width = this.dot_size+"px";
            this.div.style.height = this.dot_size+"px";
          }
        }
      }

      // let image = "/img/glider.png";
      let image = "/img/glider.png";

      redraw();

      function redraw() {
        setInterval(setTimeout(redraw, 5000)); // 5 sec
        // init overlay list
        console.log("overlayObjList.length:"+overlayObjList.length);
        overlayObjList.forEach(remove_ovrly);
        function remove_ovrly(value, index, array) {
          value.toggleDOM(map);
          // console.log("remove_ovrly:"+value.name+"//"+value.lat+"//"+value.lng+"//"+index+"//"+array);
        }
        overlayObjList = [];

        //$.get("/getCurrGlider", { lat_s: curr_lat-1, lat_e: curr_lat+1, lng_s: curr_lng-1, lng_e: curr_lng+1 }).done(function(data){ // use loc data @ done func
        $.get("/getCurrGlider", { lat_s: 32, lat_e: 33, lng_s: -112, lng_e: -109 })
        .done(function(data){
          jQuery.each(data, function( index, value ) { // for each: index in data update glider position
            // console.log("name:"+value.name);
            // console.log("position:"+value.position);
            const overlay = new GliderOverlay(value.position[0], value.position[1], image, value.name, value.position[2], value.position[3]);
            overlay.setMap(map);
            overlayObjList.push(overlay);



            // function nextPosition(value_n) {
            //   // Database
            //   overlay.lat = value_n.lat;
            //   overlay.lng = value_n.lng;
            //   overlay.alt = value_n.alt;
            //   overlay.vert_speed = value_n.vertical_speed;
            //
            //   // to refresh googlemap without manual events
            //   map.setZoom(map.getZoom()+0.0000001);
            //   map.setZoom(Math.round(map.getZoom()));
            // }


            $.get("/Database_History_Read", { name: value.name })
            .done(function(data_history){
              // data_history : sort later
              //document.write(data_history);
              let i = 0;
              jQuery.each(data_history, function( index_n, value_n ) {
                // "i == 0" means current glider's position using GliderOverlay
                if(i==0)  {
                   // setInterval(setTimeout(nextPosition, 5000, value_n)); // 5 sec
                } else {
                  // param : lat, lng, image, name, alt, vert_speed, seq
                  // model : Name: String, timestamp: Date, lat: Number, lng: Number, alt: Number, vertical_speed: Number,
                   const overlayPath = new GliderPathOverlay(value_n.lat, value_n.lng, "", value.name, value_n.alt, value_n.vertical_speed, i);
                   overlayPath.setMap(map);
                   overlayObjList.push(overlayPath);
                }
                i++;
              });
            });




            //setInterval(nextPosition, 15000); // 5 sec



          });
        });
      }


    }
    </script>
</head>

<body>

  <!-- Navigation -->
  <nav class="navbar navbar-expand-lg navbar-dark bg-dark static-top">
    <div class="container">
      <a class="navbar-brand" href="#">GlideSkyHy</a>
      <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarResponsive" aria-controls="navbarResponsive" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarResponsive">
        <ul class="navbar-nav ml-auto">
          <li class="nav-item active">
            <a class="nav-link" href="#">Pilot View
              <span class="sr-only">(current)</span>
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="#">GroundCrew View</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="javascript:genData()">Generate MockData</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="#">Sign up</a>
          </li>
          <li class="nav-item">
            <a id="currTitle4" class="nav-link dropdown-toggle" data-toggle="dropdown" href="#">Log in</a>
            <!-- Dropdown - Login-->
            <div class="dropdown-menu dropdown-menu-right shadow animated--grow-in"
                aria-labelledby="userDropdown">
                <form id="user" class="user" action="/login" method="POST">
                  <div id="dlg_login"></div>
                </form>
                <form id="user1" class="user" action="/logout" method="GET">
                  <div id="dlg_logout"></div>
                </form>
            </div>
          </li>
        </ul>
      </div>
    </div>
  </nav>

  <!-- Page Content -->
  <!-- <div class="container">
    <div class="row">
      <div class="col-lg-12 text-center"> -->
        <div id="map"></div>

        <!-- Async script executes immediately and must be after any DOM elements used in callback. -->
        <script
          src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBOSIwGZ0y53C6T_GUnfocU0muCr7bvt1Y&callback=initMap&libraries=&v=weekly"
          async
        ></script>
      <!-- </div>
    </div>
  </div> -->

  <script>
  function genData()  {
    $.get("/genData").done(function(data){
    });
  }

  // 1. LOADING
  $.get("/getCurrSt").done(function(data){
    checkLogin(data);
  });

  // 2. LOGIN FORM
  $( "#user" ).submit(function( event ) {
    // Stop form from submitting normally
    event.preventDefault();

    // Get some values from elements on the page:
    var $form = $( this ),
      v_u_name = $form.find( "input[id='u_name']" ).val(),
      v_pass_wd = $form.find( "input[id='pass_wd']" ).val(),
      url = $form.attr( "action" );
      // console.log("term:"+v_u_name);

    // Send the data using post
    var posting = $.post( url, { u_name:v_u_name, pass_wd:v_pass_wd } );

    // Put the results in a div
    posting.done(function( data ) {
      checkLogin(data);
    });
  });

  // 3. LOGOUT FORM
  $( "#user1" ).submit(function( event ) {
    // Stop form from submitting normally
    event.preventDefault();
    var $form = $( this ),
    url = $form.attr( "action" );

    // Send the data using post
    $.get(url).done(function(data){
      setCurrTitle4("Log In");
      $("#dlg_logout").html(data);
      $("#dlg_login").html("");
    });
  });
  </script>
</body>

</html>
