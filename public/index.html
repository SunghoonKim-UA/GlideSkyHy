<!DOCTYPE html>
<html lang="en">

<head>

  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="">
  <meta name="author" content="">

  <title>GlideSkyHy?!</title>

  <!-- Bootstrap core CSS -->
  <link href="vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">
  <link href="css/sk_common.css" rel="stylesheet">

  <!-- Custom fonts for this template -->
  <link href="https://fonts.googleapis.com/css?family=Catamaran:100,200,300,400,500,600,700,800,900" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css?family=Lato:100,100i,300,300i,400,400i,700,700i,900,900i" rel="stylesheet">
  <link href="vendor/colorpicker/css/bootstrap-colorpicker.css" rel="stylesheet">

  <script src="https://code.jquery.com/jquery-3.5.0.js"></script>

  <!-- Custom styles for this template -->
  <script src="https://polyfill.io/v3/polyfill.min.js?features=default"></script>
  <!-- Bootstrap core JavaScript -->
  <!-- <script src="vendor/jquery/jquery.slim.min.js"></script> -->
  <script src="vendor/easeljs.min.js"></script>
  <script src="vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
  <script src="vendor/colorpicker/js/bootstrap-colorpicker.min.js"></script>
  <script src="js/sk_common.js"></script>
  <script src="js/view_pilot.js"></script>
  <script src="js/view_history.js"></script>
  <!--<script  type="text/javascript"  src="../routes/index.js"></script>-->


  <style type="text/css">
    /* Always set the map height explicitly to define the size of the div
     * element that contains the map. */
    #map {
      height: 100%;
    }

    /* Optional: Makes the sample page fill the window. */
    html,
    body {
      height: 100%;
      margin: 0;
      padding: 0;
    }
  </style>
  <script>

    let map;
    var curr_lat = 0;
    var curr_lng = 0;
    // get current location
    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(
        (position) => {
          // console.log("position.coords.latitude:"+position.coords.latitude);
          curr_lat = position.coords.latitude;
          curr_lng = position.coords.longitude;
          // console.log("current:"+curr_lat+"//"+curr_lng);
        }
      );
    }

    var realtime_counter = 0;
    var old_lat, old_lng;

    function getlocationRealTime(glider_icon)
    {
    $("#titleFlight").html("End Flight");
     if (navigator.geolocation) {
       navigator.geolocation.getCurrentPosition(
         (position) => {
           // console.log("position.coords.latitude:"+position.coords.latitude);
           old_lat = curr_lat;
           old_lng = curr_lng
           curr_lat = position.coords.latitude;
           curr_lng = position.coords.longitude;
           curr_alt = position.coords.altitude;
           var google_lat_lng = new google.maps.LatLng(curr_lat, curr_lng);
           // console.log("current:"+curr_lat+"//"+curr_lng);
            $.get("/user/getMyInfo").done(function(glider){
                if(glider){
                  console.log(glider);
                  var postingRealtime = $.post( "/glider/Realtime_Tracking_Write", { Name:glider.name, lat:curr_lat, lng:curr_lng, alt:curr_alt, vertical_speed:1000 } );
                } else {
                  console.log("can't find glider in location db, not updating the position");
                }
            });

          map.setCenter({lat:curr_lat, lng:curr_lng});

          glider_icon.setPosition(google_lat_lng);

          // Add edge
          const flightPlanCoordinates = [
            { lat: old_lat, lng: old_lng },
            { lat: curr_lat, lng: curr_lng },
          ];
          const flightPath = new google.maps.Polyline({
            path: flightPlanCoordinates,
            geodesic: true,
            strokeColor: "red",
            strokeOpacity: 0.3,
            strokeWeight: 10,
          });

          var marker = new google.maps.Marker({
            position: google_lat_lng,
            icon: {
                    path: google.maps.SymbolPath.CIRCLE,
                    scale: 5,
                  },
            map: map
          });

          flightPath.setMap(map);

          // Todo: rotation changes



         }
       );
       console.log("realtime_counter:"+realtime_counter);
       realtime_counter = realtime_counter-1;
       if(realtime_counter>0) {

        let image = "/img/glider.png";

        var iconBase = '/img/';

        var icon = {
                  url: iconBase + 'glider.png', // url
                  scaledSize: new google.maps.Size(100, 100) // size
              };

        const feature =  {
                           position: new google.maps.LatLng(0, 0),
                           type: "pilot",
                         };
        function addMarker(feature) {
          var marker = new google.maps.Marker({
            position: feature.position,
            icon: icon,
            map: map
          });
          return marker;
        }
        var glider_icon = addMarker(feature);


        setInterval(setTimeout(getlocationRealTime, 10000, glider_icon)); // 10sec

       } else {
         $("#titleFlight").html("Start Flight");
       }
     }
    }

    function locationRealTime()
    {
      // console.log("locationRealTime()::");
      if(realtime_counter == 0) {
        realtime_counter = 10000; // Can record 27.78 hrs realtime flight  data
        getlocationRealTime();
      } else {
        $("#titleFlight").html("Start Flight");
        realtime_counter = 0;
      }
    }

    </script>
</head>

<body>

  <!-- Navigation -->
  <nav class="navbar navbar-expand-lg navbar-dark bg-dark static-top">
    <div class="container-fluid">
      <a class="navbar-brand" href="#">GlideSkyHy</a>
      <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarResponsive" aria-controls="navbarResponsive" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarResponsive">
        <ul class="navbar-nav ml-auto">
          <li class="nav-item active">
            <a id="titlePLV" class="nav-link" href="#" onclick='javascript:initMap()'>Pilot View
              <span class="sr-only">(current)</span>
            </a>
          </li>
          <li class="nav-item">
            <a id="titleGCV" class="nav-link" href="#" onclick='javascript:initMapHistory()'>History View</a>
          </li>
          <li class="nav-item">
            <a id="titleFlight" class="nav-link" href="#" onclick='javascript:locationRealTime()'>Start Flight</a>
          </li>
          <li class="nav-item">
            <a id="titleViewHist" class="nav-link" href="#" data-toggle="modal" data-target="#modViewHist">View History</a>
            <div class="modal fade" id="modViewHist" tabindex="-1" role="dialog" aria-labelledby="titleViewHist">
              <div id="dlg_viewhistory" class="modal-dialog" role="document"></div>
            </div>
          </li>
          <li class="nav-item">
            <a id="titleSignUp" class="nav-link" href="#" data-toggle="modal" data-target="#modSignUp">Sign up</a>
            <div class="modal fade" id="modSignUp" tabindex="-1" role="dialog" aria-labelledby="titleSignUp">
              <form id="signup" class="user" action="/user/signup" method="POST">
                <div id="dlg_signup" class="modal-dialog" role="document"></div>
              </form>
            </div>
          </li>
          <li class="nav-item">
            <a id="currTitle4" class="nav-link dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false" data-target="#">Log in</a>
            <!-- Dropdown - Login-->
            <div class="dropdown-menu dropdown-menu-right shadow animated--grow-in" aria-labelledby="currTitle4">
                <form id="user" class="user" action="/user/login" method="POST">
                  <div id="dlg_login"></div>
                </form>
                <form id="user1" class="user" action="/user/logout" method="GET">
                  <div id="dlg_logout"></div>
                </form>
            </div>
          </li>
        </ul>
      </div>
    </div>
  </nav>

  <!-- Page Content -->
  <!-- <div class="container">
    <div class="row">
      <div class="col-lg-12 text-center"> -->
        <div id="map"></div>

        <!-- Async script executes immediately and must be after any DOM elements used in callback. -->
        <script
          src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBOSIwGZ0y53C6T_GUnfocU0muCr7bvt1Y&map_ids=95d9a8faa1b776b&callback=initMap&libraries=&v=weekly"
          async
        ></script>
      <!-- </div>
    </div>
  </div> -->

  <script>
  // 1. LOADING
  $.get("/user/getCurrSt").done(function(data){
    checkLogin(data);
  });
  $( "#dlg_signup" ).load( "signup.html" );
  $( "#dlg_viewhistory" ).load( "viewhistory.html" );


  // 2. LOGIN FORM
  $( "#user" ).submit(function( event ) {
    // Stop form from submitting normally
    event.preventDefault();

    // Get some values from elements on the page:
    var $form = $( this ),
      v_u_name = $form.find( "input[id='u_name']" ).val(),
      v_pass_wd = $form.find( "input[id='pass_wd']" ).val(),
      url = $form.attr( "action" );
      // console.log("term:"+v_u_name);

    // Send the data using post
    var posting = $.post( url, { u_name:v_u_name, pass_wd:v_pass_wd } );

    // Put the results in a div
    posting.done(function( data ) {
      checkLogin(data);
    });
  });

  // 3. LOGOUT FORM
  $( "#user1" ).submit(function( event ) {
    // Stop form from submitting normally
    event.preventDefault();
    var $form = $( this ),
    url = $form.attr( "action" );

    // Send the data using post
    $.get(url).done(function(data){
      afterLogout(data);
    });
  });

    // 4. Signup FORM
    $( "#signup" ).submit(function( event ) {
      console.log("Signup start");
      // Stop form from submitting normally
      event.preventDefault();
      var $form = $( this ),
      v_new_name = $form.find( "input[id='new_name']" ).val(),
      v_new_passwd = $form.find( "input[id='new_passwd']" ).val(),
      v_new_color = $form.find( "input[id='new_color']" ).val(),
      url = $form.attr( "action" );
      // console.log("term:"+v_u_name);

      // Send the data using post
      $.post(url, { new_name:v_new_name, new_passwd:v_new_passwd, new_color:v_new_color } )
       .done(function(data){
        if(data.msg == "") {
          $("#signupMsg").html("Signed up successfully.");
          $("#signupBtn").hide();
        } else {
          $("#signupMsg").html(data.msg);
        }
      });
    });
  </script>
</body>

</html>
